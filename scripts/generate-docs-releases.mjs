import { execSync } from 'node:child_process';
import { mkdirSync, readFileSync, writeFileSync } from 'node:fs';
import { dirname, resolve } from 'node:path';
import { fileURLToPath } from 'node:url';

const __dirname = dirname(fileURLToPath(import.meta.url));
const repoRoot = resolve(__dirname, '..');

const outputJsonPath = resolve(repoRoot, 'apps/docs/src/generated/releases.json');
const outputMdxPath = resolve(repoRoot, 'apps/docs/src/content/docs/releases/index.mdx');

const run = (command) => {
  try {
    return execSync(command, { cwd: repoRoot, stdio: ['ignore', 'pipe', 'ignore'], encoding: 'utf8' }).trim();
  } catch {
    return '';
  }
};

const toGitHubHttpUrl = (remote) => {
  if (!remote) {
    return null;
  }

  if (remote.startsWith('git@github.com:')) {
    return `https://github.com/${remote.slice('git@github.com:'.length).replace(/\.git$/, '')}`;
  }

  if (remote.startsWith('https://github.com/')) {
    return remote.replace(/\.git$/, '');
  }

  return null;
};

const packageJson = JSON.parse(readFileSync(resolve(repoRoot, 'packages/scholar-mcp/package.json'), 'utf8'));
const currentVersion = packageJson.version ?? 'unknown';

const tagRowsRaw = run("git for-each-ref --sort=-v:refname --format='%(refname:short)|%(creatordate:short)|%(subject)' refs/tags");

const rows = tagRowsRaw
  .split('\n')
  .map((line) => line.trim())
  .filter(Boolean)
  .map((line) => {
    const [tag, date, subject] = line.split('|');
    return {
      tag,
      date,
      subject
    };
  })
  .filter((row) => /^v?\d+\.\d+\.\d+([-.].+)?$/.test(row.tag))
  .slice(0, 100);

const remote = run('git remote get-url origin');
const repoUrl = toGitHubHttpUrl(remote);

const releases = rows.map((row) => ({
  ...row,
  url: repoUrl ? `${repoUrl}/releases/tag/${encodeURIComponent(row.tag)}` : null
}));

const payload = {
  currentVersion,
  generatedFrom: 'git tags',
  releaseCount: releases.length,
  releases
};

const releaseLines = releases.length
  ? releases
      .map((release) => {
        const label = release.url ? `[\`${release.tag}\`](${release.url})` : `\`${release.tag}\``;
        const details = [release.date || 'unknown date', release.subject || 'no subject'].join(' - ');
        return `- ${label}: ${details}`;
      })
      .join('\n')
  : '- No semantic version tags found yet.';

const mdx = `---
title: Release Notes
description: Generated release index from repository tags.
sidebar:
  order: 1
---

> Auto-generated by \`scripts/generate-docs-releases.mjs\` from repository tags.

Current package version from \`packages/scholar-mcp/package.json\`: **${currentVersion}**.

## Published Tags

${releaseLines}
`;

mkdirSync(dirname(outputJsonPath), { recursive: true });
mkdirSync(dirname(outputMdxPath), { recursive: true });
writeFileSync(outputJsonPath, `${JSON.stringify(payload, null, 2)}\n`, 'utf8');
writeFileSync(outputMdxPath, `${mdx}\n`, 'utf8');

process.stdout.write(`Generated releases index with ${releases.length} tag entries.\n`);
