name: Publish to GitHub Packages

on:
  release:
    types: [published]

permissions:
  contents: read
  packages: write

jobs:
  publish-github-packages:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: https://npm.pkg.github.com
          scope: "@${{ github.repository_owner }}"
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run preflight checks
        run: pnpm --filter scholar-mcp release:check

      - name: Verify version matches release tag
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG#v}"
          PKG_VERSION=$(node -p "require('./packages/scholar-mcp/package.json').version")
          if [ "$VERSION" != "$PKG_VERSION" ]; then
            echo "Version mismatch: tag=$VERSION, package.json=$PKG_VERSION"
            exit 1
          fi
          echo "Version verified: $VERSION"

      - name: Rewrite package scope for GitHub Packages
        run: |
          OWNER="$(printf '%s' "$GITHUB_REPOSITORY_OWNER" | tr '[:upper:]' '[:lower:]')"
          PKG_PATH="packages/scholar-mcp/package.json"
          ORIG_NAME=$(node -p "require('./$PKG_PATH').name")

          if [[ "$ORIG_NAME" == @*/* ]]; then
            GH_NAME="$ORIG_NAME"
          else
            GH_NAME="@$OWNER/$ORIG_NAME"
          fi

          PKG_PATH="$PKG_PATH" GH_NAME="$GH_NAME" node -e '
            const fs = require("node:fs");
            const path = process.env.PKG_PATH;
            const ghName = process.env.GH_NAME;
            const pkg = JSON.parse(fs.readFileSync(path, "utf8"));
            pkg.name = ghName;
            pkg.publishConfig = {
              ...(pkg.publishConfig || {}),
              registry: "https://npm.pkg.github.com"
            };
            fs.writeFileSync(path, JSON.stringify(pkg, null, 2) + "\n");
          '

          echo "Prepared package for GitHub Packages as $GH_NAME"

      - name: Publish to GitHub Packages
        run: pnpm --filter scholar-mcp publish --no-git-checks --registry https://npm.pkg.github.com
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
