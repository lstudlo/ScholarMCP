---
import { getCollection } from 'astro:content';
import DocsLayout from '../layouts/DocsLayout.astro';
import SiteShell from '../components/docs/SiteShell.astro';
import { breadcrumbParts, getDocPageContext, renderDocEntry } from '../lib/docs';

export const prerender = true;

export async function getStaticPaths() {
  const docs = await getCollection('docs', ({ data }) => !data.draft);
  return docs.map((entry) => ({
    params: { slug: entry.id === 'index' ? undefined : entry.id.replace(/\/index$/, '') },
    props: { docId: entry.id }
  }));
}

const { docId } = Astro.props as { docId: string };
const context = await getDocPageContext(docId);

if (!context) {
  throw new Error(`Unknown docs entry: ${docId}`);
}

const { page, sidebar, prev, next } = context;
const { Content, headings } = await renderDocEntry(page.entry);
const title = page.id === 'index' ? `${page.label} | ScholarMCP` : `${page.label} | ScholarMCP Docs`;
const description = page.entry.data.description ?? 'ScholarMCP documentation';
const isHome = page.id === 'index' || page.entry.data.template === 'splash';
const crumbs = breadcrumbParts(page);

type Heading = { depth: number; slug: string; text: string };
const toc = (headings as Heading[]).filter((h) => h.depth >= 2 && h.depth <= 3);

const HOME_SECTION_SUMMARIES: Record<string, string> = {
  'Getting Started': 'Installation, client setup, and local development for running ScholarMCP quickly.',
  'Usage Guides': 'Practical research workflows, ingestion patterns, and day-to-day usage recipes.',
  Reference: 'Complete command, configuration, and tool reference documentation.',
  Releases: 'Version notes and release history for the ScholarMCP project.'
};

const homeSectionCards = isHome
  ? Array.from(
      context.pages
        .filter((item) => item.id !== 'index' && item.sectionLabel)
        .reduce((map, item) => {
          const key = item.sectionLabel!;
          const list = map.get(key) ?? [];
          list.push(item);
          map.set(key, list);
          return map;
        }, new Map<string, typeof context.pages>())
        .entries()
    ).map(([label, items]) => {
      const primary = items[0];
      return {
        label,
        href: primary?.section ? `/${primary.section}/` : primary?.href ?? '/',
        count: items.length,
        summary: HOME_SECTION_SUMMARIES[label] ?? `${items.length} documentation page${items.length === 1 ? '' : 's'} available.`,
        items: items.slice(0, 4)
      };
    })
  : [];
---

<DocsLayout title={title} description={description}>
  <SiteShell sidebar={sidebar} currentPage={page} toc={toc} prev={prev} next={next} isHome={isHome}>
    {
      isHome ? (
        <div class="space-y-10">
          <section>
            <article class="mx-auto rounded-4xl border border-zinc-200/80 bg-white/75 p-6 shadow-xl backdrop-blur sm:p-8 dark:border-zinc-800 dark:bg-zinc-950/70">
              <p class="text-[11px] tracking-[0.18em] text-zinc-500 uppercase">ScholarMCP Docs</p>
              <h1 class="mt-3 max-w-3xl font-serif text-4xl leading-tight tracking-tight sm:text-5xl">
                {page.entry.data.hero?.title ?? page.entry.data.title}
              </h1>
              {page.entry.data.hero?.tagline && (
                <p class="mt-4 max-w-2xl text-sm leading-6 text-zinc-600 dark:text-zinc-300">
                  {page.entry.data.hero.tagline}
                </p>
              )}
              {page.entry.data.hero?.actions?.length ? (
                <div class="mt-8 flex flex-wrap gap-2">
                  {page.entry.data.hero.actions.map((action) => (
                    <a
                      href={action.link}
                      class:list={[
                        'rounded-full px-4 py-2 text-xs tracking-[0.16em] uppercase transition',
                        action.variant === 'minimal'
                          ? 'border border-zinc-300/80 hover:bg-zinc-100 dark:border-zinc-700 dark:hover:bg-zinc-900'
                          : 'border border-[var(--accent)] bg-[var(--accent)] text-white hover:opacity-90 dark:text-zinc-950'
                      ]}
                    >
                      {action.text}
                    </a>
                  ))}
                </div>
              ) : null}

            </article>
          </section>

          <section id="docs-index">
            <div class="mb-4 flex items-end justify-between gap-4 px-1">
              <div>
                <p class="text-[11px] tracking-[0.16em] text-zinc-500 uppercase">All Docs</p>
                <h2 class="mt-1 font-serif text-2xl tracking-tight sm:text-3xl">
                  Browse documentation by section
                </h2>
              </div>
              <p class="hidden text-xs text-zinc-500 md:block">
                Open a section card to explore pages, guides, and reference docs.
              </p>
            </div>

            <div class="grid gap-4 md:grid-cols-2 xl:grid-cols-3">
              {homeSectionCards.map((section) => (
                <article class="flex h-full flex-col justify-between rounded-4xl border border-zinc-200/80 bg-white/75 p-5 backdrop-blur transition hover:-translate-y-0.5 hover:border-zinc-900 dark:border-zinc-800 dark:bg-zinc-950/70 dark:hover:border-zinc-100">
                  <div>
                    <div class="flex items-start justify-between gap-3">
                      <div class="min-w-0">
                        <p class="truncate text-[11px] tracking-[0.16em] text-zinc-500 uppercase">
                          Documentation
                        </p>
                        <h3 class="mt-1 line-clamp-2 font-serif text-2xl leading-tight tracking-tight">
                          <a href={section.href} class="hover:underline">
                            {section.label}
                          </a>
                        </h3>
                      </div>
                    </div>

                    <p class="mt-3 text-sm leading-6 text-zinc-600 dark:text-zinc-300">
                      {section.summary}
                    </p>

                    <div class="mt-5 rounded-xl border border-zinc-200/80 bg-zinc-50/60 p-3 dark:border-zinc-800 dark:bg-zinc-900/50">
                      <div class="flex w-full items-center justify-between gap-2">
                        <p class="text-[11px] tracking-widest text-zinc-500 uppercase">Pages</p>
                        <span class="shrink-0 rounded-full border border-zinc-300/80 px-2 py-0.5 font-mono text-[11px] dark:border-zinc-700">
                          {section.count}
                        </span>
                      </div>
                      <ul class="mt-2 space-y-1 text-sm text-zinc-700 dark:text-zinc-300">
                        {section.items.map((item) => (
                          <li class="truncate">
                            <a href={item.href} class="hover:text-zinc-950 hover:underline dark:hover:text-zinc-50">
                              {item.label}
                            </a>
                          </li>
                        ))}
                      </ul>
                    </div>
                  </div>

                  <div class="mt-5 flex items-center gap-2">
                    <a
                      href={section.href}
                      class="inline-flex rounded-full border border-[var(--accent)] bg-[var(--accent)] px-3 py-1.5 text-xs tracking-[0.14em] text-white uppercase hover:opacity-90 dark:text-zinc-950"
                    >
                      Open
                    </a>
                  </div>
                </article>
              ))}
            </div>
          </section>

          <section>
            <div class="mb-4 flex items-end justify-between gap-4 px-1">
              <div>
                <p class="text-[11px] tracking-[0.16em] text-zinc-500 uppercase">Overview</p>
                <h2 class="mt-1 font-serif text-2xl tracking-tight sm:text-3xl">
                  Product overview and entry points
                </h2>
              </div>
            </div>

            <article class="prose-wrap splash-prose rounded-3xl border border-zinc-200/80 bg-white/75 p-5 backdrop-blur sm:p-6 dark:border-zinc-800 dark:bg-zinc-950/70">
              <Content />
            </article>
          </section>
        </div>
      ) : (
        <div class="space-y-5">
          <div class="rounded-3xl border border-zinc-200/80 bg-white/75 p-5 backdrop-blur sm:p-6 dark:border-zinc-800 dark:bg-zinc-950/70">
            <nav class="text-xs text-zinc-500">
              <a href="/" class="hover:text-zinc-900 hover:underline dark:hover:text-zinc-100">Docs</a>
              {crumbs.map((crumb) => (
                <>
                  <span class="mx-2">/</span>
                  {crumb.isCurrent ? (
                    <span class="font-mono">{crumb.label}</span>
                  ) : (
                    <a href={crumb.href} class="hover:text-zinc-900 hover:underline dark:hover:text-zinc-100">
                      {crumb.label}
                    </a>
                  )}
                </>
              ))}
            </nav>

            <h1 id="_top" class="mt-3 font-serif text-4xl leading-tight tracking-tight sm:text-5xl">
              {page.entry.data.title}
            </h1>
            {page.entry.data.description && (
              <p class="mt-4 max-w-3xl text-sm leading-6 text-zinc-600 dark:text-zinc-300">
                {page.entry.data.description}
              </p>
            )}
          </div>

          <article class="prose-wrap rounded-3xl border border-zinc-200/80 bg-white/75 p-6 backdrop-blur sm:p-7 dark:border-zinc-800 dark:bg-zinc-950/70">
            <Content />
          </article>
        </div>
      )
    }
  </SiteShell>
</DocsLayout>
