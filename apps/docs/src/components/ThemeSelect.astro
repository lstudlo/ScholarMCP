---
const a11yLabel = Astro.locals.t('themeSelect.accessibleLabel');
---

<starlight-theme-toggle>
  <button
    type="button"
    class="inline-flex items-center gap-2 rounded-full border border-zinc-300/80 bg-white/70 px-3 py-1.5 text-xs tracking-[0.16em] uppercase backdrop-blur transition hover:bg-zinc-50 dark:border-zinc-700 dark:bg-black/70 dark:hover:bg-zinc-900"
    aria-label={a11yLabel}
    title={a11yLabel}
  >
    <span class="size-1.5 rounded-full bg-[var(--accent)]" aria-hidden="true"></span>
    <span data-theme-toggle-label aria-hidden="true">Theme</span>
  </button>
</starlight-theme-toggle>

<script>
  type Theme = 'light' | 'dark';

  const storageKey = 'starlight-theme';

  const preferredTheme = (): Theme =>
    matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark';

  const readStoredTheme = (): Theme | null => {
    if (typeof localStorage === 'undefined') return null;
    const value = localStorage.getItem(storageKey);
    return value === 'light' || value === 'dark' ? value : null;
  };

  const applyTheme = (theme: Theme) => {
    document.documentElement.dataset.theme = theme;
  };

  const storeTheme = (theme: Theme) => {
    if (typeof localStorage !== 'undefined') localStorage.setItem(storageKey, theme);
  };

  const resolveInitialTheme = (): Theme =>
    readStoredTheme() ?? (document.documentElement.dataset.theme === 'light' ? 'light' : preferredTheme());

  class StarlightThemeToggle extends HTMLElement {
    mediaQuery = matchMedia('(prefers-color-scheme: light)');
    button: HTMLButtonElement | null = null;
    label: HTMLElement | null = null;
    clickHandler = () => {
      const nextTheme: Theme = document.documentElement.dataset.theme === 'dark' ? 'light' : 'dark';
      applyTheme(nextTheme);
      storeTheme(nextTheme);
      this.syncLabel();
    };

    syncLabel() {
      if (this.label) this.label.textContent = document.documentElement.dataset.theme === 'dark' ? 'Dark' : 'Light';
    }

    onSystemThemeChange = () => {
      if (!readStoredTheme()) {
        applyTheme(preferredTheme());
        this.syncLabel();
      }
    };

    connectedCallback() {
      if (this.dataset.bound === 'true') {
        this.syncLabel();
        return;
      }

      this.button = this.querySelector('button');
      this.label = this.querySelector('[data-theme-toggle-label]');
      if (!(this.button instanceof HTMLButtonElement)) return;

      applyTheme(resolveInitialTheme());
      this.syncLabel();
      this.dataset.bound = 'true';

      this.button.addEventListener('click', this.clickHandler);

      this.mediaQuery.addEventListener('change', this.onSystemThemeChange);
    }

    disconnectedCallback() {
      this.button?.removeEventListener('click', this.clickHandler);
      this.mediaQuery.removeEventListener('change', this.onSystemThemeChange);
      delete this.dataset.bound;
    }
  }

  if (!customElements.get('starlight-theme-toggle')) {
    customElements.define('starlight-theme-toggle', StarlightThemeToggle);
  }
</script>
