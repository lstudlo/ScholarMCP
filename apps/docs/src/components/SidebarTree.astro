---
interface Badge {
  text: string;
  class?: string;
}

interface SidebarLink {
  type: 'link';
  label: string;
  href: string;
  isCurrent: boolean;
  badge?: Badge;
}

interface SidebarGroup {
  type: 'group';
  label: string;
  entries: SidebarEntry[];
  collapsed: boolean;
  badge?: Badge;
}

type SidebarEntry = SidebarLink | SidebarGroup;

interface Props {
  items: SidebarEntry[];
  nested?: boolean;
}

const { items, nested = false } = Astro.props as Props;

const groupHasCurrent = (entry: SidebarGroup): boolean =>
  entry.entries.some((child) => (child.type === 'link' ? child.isCurrent : groupHasCurrent(child)));
---

<ul class:list={[nested ? 'space-y-1.5 pl-3' : 'space-y-2']}>
  {
    items.map((entry) => (
      <li>
        {entry.type === 'link' ? (
          <a
            href={entry.href}
            aria-current={entry.isCurrent ? 'page' : undefined}
            class:list={[
              'group flex items-center justify-between gap-2 rounded-xl px-3 py-2 text-sm leading-5 transition',
              nested
                ? 'text-zinc-700 hover:bg-zinc-100/80 hover:text-zinc-950 dark:text-zinc-300 dark:hover:bg-zinc-900 dark:hover:text-zinc-50'
                : 'text-zinc-800 hover:bg-zinc-100/80 hover:text-zinc-950 dark:text-zinc-200 dark:hover:bg-zinc-900 dark:hover:text-zinc-50',
              entry.isCurrent &&
                'border border-[color-mix(in_srgb,var(--accent)_45%,transparent)] bg-[color-mix(in_srgb,var(--accent)_16%,transparent)] text-zinc-950 dark:text-zinc-50'
            ]}
          >
            <span class:list={['min-w-0 truncate', !nested && 'font-medium']}>{entry.label}</span>
            {entry.badge && (
              <span
                class:list={[
                  'shrink-0 rounded-full border border-zinc-300/80 px-2 py-0.5 font-mono text-[10px] uppercase dark:border-zinc-700',
                  entry.badge.class
                ]}
              >
                {entry.badge.text}
              </span>
            )}
          </a>
        ) : (
          <details
            open={groupHasCurrent(entry) || !entry.collapsed}
            class="group rounded-2xl border border-zinc-200/80 bg-white/50 px-2 py-2 dark:border-zinc-800 dark:bg-zinc-950/40"
          >
            <summary class="flex cursor-pointer list-none items-center justify-between gap-3 rounded-xl px-2 py-2 hover:bg-zinc-100/80 dark:hover:bg-zinc-900">
              <span class="min-w-0 truncate text-sm font-medium text-zinc-900 dark:text-zinc-100">
                {entry.label}
              </span>
              <span class="shrink-0 text-xs text-zinc-500 transition group-open:rotate-90">â€º</span>
            </summary>
            <div class="mt-1 border-l border-zinc-200/80 pl-2 dark:border-zinc-800">
              <Astro.self items={entry.entries} nested />
            </div>
          </details>
        )}
      </li>
    ))
  }
</ul>

<style>
  @layer starlight.core {
    summary::-webkit-details-marker {
      display: none;
    }
  }
</style>
